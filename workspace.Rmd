---
title: "Isotope_workspace"
output: html_document
---

```{r}
source("functions.R")
```

Packages to install:

```{r}
install.packages('rnoaa')
```

```{r}
install.packages('zoo')
install.packages('ggplot2')
```

```{r}
install.packages("deseasonalize")
```

```{r}
install.packages('forecast')
```

Source functions:

Library:

```{r}
library(rnoaa)
library(zoo)
library(deseasonalize)
library(forecast)
library(ggplot2)
```

noaaGet - This is a function that, using rnoaa, will collect monthly NCDC data (from a given site, data type, and year range) and return it in a single, usable dataframes, as opposed to a list of dataframes for each year

```{r}
noaaGet <- function(station, dtype, beginyr, endyr){ 
  Values <- vector(mode="list",length=1)
  for (year in seq(beginyr, endyr)){
  stDate <- paste0(year, "-01-01")
  endDate <- paste0(year, "-12-31")
 Tdat <- ncdc(datasetid='GSOM', stationid = station, datatypeid=dtype, startdate = stDate, enddate = endDate, limit = 100, add_units=TRUE)
 name <- paste0(dtype, year)
  Values[[name]] <- Tdat[[2]]
  }
  totyr <- (endyr - beginyr + 2)
Combined <- rbind(Values[[2]], Values[[3]])
  for (num in 4:totyr){
    Combined <- rbind(Combined, Values[[num]])
  }
return(Combined)
}
```

```{r}
noaaGet("GHCND:CI000085799", "PRCP", 1995, 2000)
```

```{r}
CG_series <- isoTempPrecip(gnip_capegrim.csv, CapeGrimTAVG, CapeGrimPRCP)
CG_series
```


read in isotope data (unfortunately, wget does not work with IAEA's data acquisition portal, and there is no API to go with it)

```{r}
data.path <- "./IsotopeData/"
glob.path <- paste0(data.path, "*", ".csv")  
dataFiles <- Sys.glob(glob.path)
for(x in 1:length(dataFiles)){
  temporaryFile <- read.csv(dataFiles[x])
  assign(basename(dataFiles[x]), temporaryFile)
}
rm(temporaryFile)
```


```{r}
length(dataFiles)
```

Tool to combine temp, precip, and O18 time series, using R package zoo



```{r}
isoTempPrecip <- function(iso, temp, precip){
  temp$date <- strtrim(temp$date, 10)
  precip$date <- strtrim(precip$date, 10)
  zooIso <- zoo(iso[,c(17)], as.Date(iso[, 14]))
  zooTemp <- zoo(temp[,4], as.Date(temp$date))
  zooPrecip <- zoo(precip[,4], as.Date(precip$date))
  IsoTimeSeries <- merge(zooTemp, zooPrecip, zooIso, all=FALSE)
  colnames(IsoTimeSeries) <- c("Temp","Precip","O18")
  return(IsoTimeSeries)
}
```

```{r}
iso2 <- isoTempCompare(CG_iso, grim_temp, grim_precip)
iso2
```

ggplot2

```{r}
plot(iso2, plot.type = 'multiple', col = c('red', 'blue', 'green'), lwd=2)
```

read in and plot O18 for multiple sites, using R package zoo

```{r}
IsoCompare <- function(first, second, third=NULL, fourth=NULL, fifth=NULL){
  zooIso1 <- zoo(first[,c(17)], as.Date(first[, 14]))
  zooIso2 <- zoo(second[,c(17)], as.Date(second[, 14]))
  IsoCombined <- merge(zooIso1, zooIso2)
  if(!is.null(third)){
    zooIso3 <- zoo(third[,c(17)], as.Date(third[, 14]))
    IsoCombined <- merge(IsoCombined, zooIso3)
  }
  if(!is.null(fourth)){
    zooIso4 <- zoo(fourth[,c(17)], as.Date(fourth[, 14]))
    IsoCombined <- merge(IsoCombined, zooIso4)
  }
  if(!is.null(fifth)){
    zooIso5 <- zoo(fifth[,c(17)], as.Date(fifth[, 14]))
    IsoCombined <- merge(IsoCombined, zooIso5)
  }
  return(IsoCombined)
}
```

```{r}
isoSites <- IsoCompare(gnip_puertomontt.csv, gnip_goughisland.csv, gnip_marionisland.csv, gnip_capegrim.csv, gnip_margate.csv)
colnames(isoSites) <- c("PuertoMontt","Gough","Marion","CapeGrim","Margate")
head(isoSites)
```

Can limit date range for isoSites using window()

```{r}
isoWindow <- window(isoSites, start="1992-01-01", end="1999-12-31")
autoplot.zoo(isoWindow)
```

ggplot2

```{r}
plot(wat, plot.type = 'multiple', col = c('red', 'blue', 'green', 'yellow', 'black'), lwd=2)
```

```{r}
autoplot.zoo(isoSites)
```

Looping noaaGet for multiple sites. first step is to have a named vector of all wanted sites

```{r}
sites <- c('GHCND:CI000085799','GHCND:SHM00068906','GHCND:SF000068994','GHCND:ASN00091245','GHCND:ASN00094125')
names(sites) <- c('PuertoMontt','Gough','Marion','CapeGrim','Margate')
sites
```

```{r}
length(sites)
```


```{r}
for (x in 1:length(sites)){
  for (y in c('PRCP','TAVG')){
    DataTemp <- noaaGet(sites[[x]], y, 1980, 2018)
    assign(paste0(names(sites[x]),y), DataTemp)
  }
}
rm(DataTemp)
```




Future areas:

-Decompose and deseasonalize
-Analyze data at a finer temporal resolution


Everything below is deseasonalizing. Hard stuff



```{r}
testdata <- grim_data$value
testdata
```


```{r}
helpme <- ts(testdata)
stl(helpme,"periodic")
```
